name: Incident Response & Self-Healing

on:
  workflow_run:
    workflows: ["Claude Code"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      incident_type:
        description: 'Type of incident'
        required: true
        type: choice
        options:
          - deployment_failure
          - test_failure
          - security_alert
          - performance_degradation

permissions:
  issues: write
  contents: write
  actions: write
  pull-requests: write

jobs:
  detect-incident:
    runs-on: ubuntu-latest
    outputs:
      is_incident: ${{ steps.detect.outputs.is_incident }}
      incident_severity: ${{ steps.detect.outputs.severity }}

    steps:
      - name: Detect incident
        id: detect
        run: |
          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œçµæœã‚’ç¢ºèª
          if [ "${{ github.event.workflow_run.conclusion }}" = "failure" ]; then
            echo "is_incident=true" >> $GITHUB_OUTPUT
            echo "severity=P1-High" >> $GITHUB_OUTPUT
            echo "ğŸš¨ Incident detected: Workflow failure"
          else
            echo "is_incident=false" >> $GITHUB_OUTPUT
            echo "âœ… No incident detected"
          fi

  self-healing:
    needs: detect-incident
    if: needs.detect-incident.outputs.is_incident == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œå…¨ãªå±¥æ­´ã‚’å–å¾—

      - name: Attempt automatic rollback
        id: rollback
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”„ Attempting automatic rollback..."

          # æœ€å¾Œã®æˆåŠŸã—ãŸã‚³ãƒŸãƒƒãƒˆã‚’ç‰¹å®š
          LAST_SUCCESSFUL_COMMIT=$(git log --format="%H" --grep="success" -1 || git rev-parse HEAD~1)

          # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è©¦è¡Œã‚«ã‚¦ãƒ³ãƒˆ
          ATTEMPT=1
          MAX_ATTEMPTS=3

          echo "attempt=$ATTEMPT" >> $GITHUB_OUTPUT
          echo "max_attempts=$MAX_ATTEMPTS" >> $GITHUB_OUTPUT

          # Note: å®Ÿéš›ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯ã“ã“ã§å®Ÿè£…
          # git revert ã‚„ git reset ã®å®Ÿè¡Œ

          echo "âœ… Rollback attempt completed"

      - name: Execute Handshake Protocol on repeated failures
        if: failure() && steps.rollback.outputs.attempt >= '3'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;

            // è©¦è¡Œã—ãŸã™ã¹ã¦ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è©³ç´°
            const systemDetails = `
            ### ã‚·ã‚¹ãƒ†ãƒ è©³ç´°

            - **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:** ${{ github.event.workflow_run.name }}
            - **å®Ÿè¡ŒID:** ${{ github.event.workflow_run.id }}
            - **å¤±æ•—æ™‚åˆ»:** ${{ github.event.workflow_run.updated_at }}
            - **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è©¦è¡Œå›æ•°:** ${{ steps.rollback.outputs.attempt }}/${{ steps.rollback.outputs.max_attempts }}

            ### åé›†ã—ãŸãƒ‡ãƒ¼ã‚¿

            - **æœ€çµ‚æˆåŠŸã‚³ãƒŸãƒƒãƒˆ:** ç‰¹å®šæ¸ˆã¿
            - **ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°:** [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒ­ã‚°å‚ç…§](${{ github.event.workflow_run.html_url }})
            - **å½±éŸ¿ç¯„å›²:** èª¿æŸ»ä¸­

            ### è©¦è¡Œã—ãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³

            1. âœ… ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆæ¤œçŸ¥
            2. âœ… è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è©¦è¡Œ (3å›)
            3. âŒ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¤±æ•—

            ---

            ## ğŸ†˜ Handshake Protocol

            **æˆ‘ã€…ã®è‡ªå¾‹æ€§ã¯é™ç•Œã«é”ã—ã¾ã—ãŸã€‚Guardian ã®ä»‹å…¥ã‚’è¦è«‹ã—ã¾ã™ã€‚**

            ã‚·ã‚¹ãƒ†ãƒ ã¯ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«ãƒ»ãƒ‡ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ã«ç§»è¡Œã—ã€å½±éŸ¿ã‚’æœ€å°é™ã«æŠ‘ãˆã¦ã„ã¾ã™ã€‚

            ### Guardian ãŒç¢ºèªã™ã¹ãäº‹é …

            1. æ ¹æœ¬åŸå› ã®æ‰‹å‹•åˆ†æ
            2. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå¤±æ•—ã—ãŸç†ç”±
            3. å¾©æ—§æ‰‹é †ã®æ±ºå®š
            4. ã‚·ã‚¹ãƒ†ãƒ ã®å†é–‹æ‰¿èª

            ---

            **AGENTS.md å‚ç…§:** [ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«ãƒ»ãƒ‡ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ—ãƒ­ãƒˆã‚³ãƒ«](../AGENTS.md#graceful_degradation_and_human_escalation_protocol)
            `;

            await github.rest.issues.create({
              owner,
              repo,
              title: 'ğŸ¤–ğŸ†˜ HANDSHAKE PROTOCOL: Autonomous Recovery Failed',
              body: systemDetails,
              labels: ['human-intervention-required', 'P0-Critical', 'incident-response']
            });

            console.log('ğŸ†˜ Handshake Protocol executed: Human intervention requested');

      - name: Apply graceful degradation
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ›¡ï¸ Applying graceful degradation..."

          # æ–°è¦ãƒ‡ãƒ—ãƒ­ã‚¤ã®åœæ­¢ï¼ˆè©²å½“ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒã‚ã‚Œã°ï¼‰
          # æ©Ÿèƒ½ãƒ•ãƒ©ã‚°ã§ã®å½±éŸ¿æ©Ÿèƒ½ã®OFFï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰

          echo "âœ… Graceful degradation applied"

      - name: Success notification
        if: success()
        run: |
          echo "âœ… Self-healing completed successfully"
          echo "System has recovered automatically"
