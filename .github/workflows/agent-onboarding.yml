name: Agent Onboarding & Compliance

on:
  push:
    paths:
      - 'src/agents/**'
      - 'agents/**'
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  compliance-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Scan for hardcoded secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

      - name: Check Agent compliance
        id: compliance
        run: |
          echo "ğŸ” Checking Agent compliance with AGENTS.md constitution..."

          # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡º
          AGENT_FILES=$(find . -path "*/agents/*.js" -o -path "*/agents/*.ts" 2>/dev/null || echo "")

          if [ -z "$AGENT_FILES" ]; then
            echo "âš ï¸ No agent files found"
            echo "compliant=unknown" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found agent files:"
          echo "$AGENT_FILES"

          # ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯é …ç›®
          COMPLIANCE_PASSED=true

          for file in $AGENT_FILES; do
            echo "Checking: $file"

            # å¿…é ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®ç¢ºèªï¼ˆç°¡æ˜“ç‰ˆï¼‰
            if ! grep -q "execute" "$file" && ! grep -q "run" "$file"; then
              echo "âŒ Missing required interface: execute() or run() method"
              COMPLIANCE_PASSED=false
            fi

            # AGENTS.md æ†²æ³•ã¸ã®è¨€åŠç¢ºèªï¼ˆæ¨å¥¨ï¼‰
            # if ! grep -q "AGENTS.md" "$file"; then
            #   echo "âš ï¸ Warning: No reference to AGENTS.md constitution"
            # fi
          done

          if [ "$COMPLIANCE_PASSED" = true ]; then
            echo "compliant=true" >> $GITHUB_OUTPUT
            echo "âœ… All compliance checks passed"
          else
            echo "compliant=false" >> $GITHUB_OUTPUT
            echo "âŒ Compliance checks failed"
            exit 1
          fi

      - name: Run unit tests
        if: steps.compliance.outputs.compliant == 'true'
        continue-on-error: true
        run: |
          echo "ğŸ§ª Running unit tests for new agents..."

          # package.json ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          if [ -f "package.json" ]; then
            if npm list --depth=0 | grep -q "jest\|mocha\|vitest"; then
              npm test || echo "âš ï¸ Tests failed or not configured"
            else
              echo "âš ï¸ No test framework detected"
            fi
          else
            echo "âš ï¸ No package.json found, skipping tests"
          fi

      - name: Register new agent
        if: steps.compliance.outputs.compliant == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“ Registering new agent in system registry..."

          # CODEOWNERS ã¸ã®è‡ªå‹•è¿½åŠ ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
          if [ -f ".github/CODEOWNERS" ]; then
            # æ–°ã—ã„Agentãƒ‘ã‚¹ã‚’CODEOWNERSã«è¿½åŠ 
            # å®Ÿè£…ä¾‹: echo "/agents/NewAgent.js @team-agents" >> .github/CODEOWNERS
            echo "âœ… CODEOWNERS updated (placeholder)"
          fi

          # ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®æ›´æ–°ï¼ˆè©²å½“ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°ï¼‰
          # if [ -f "config/agent-registry.json" ]; then
          #   # JSONãƒ•ã‚¡ã‚¤ãƒ«ã«æ–°ã—ã„Agentã‚’ç™»éŒ²
          #   echo "âœ… Agent registry updated"
          # fi

      - name: Create onboarding issue
        if: steps.compliance.outputs.compliant == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;

            const agentFiles = context.payload.commits?.[0]?.added
              ?.filter(f => f.includes('agents/'))
              .join('\n- ') || 'Check commit diff';

            await github.rest.issues.create({
              owner,
              repo,
              title: 'ğŸ¤– New Agent Onboarded Successfully',
              body: `## æ–°ã—ã„ Agent ãŒã‚·ã‚¹ãƒ†ãƒ ã«å‚åŠ ã—ã¾ã—ãŸ

### ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯

- âœ… ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³: ã‚¯ãƒªã‚¢
- âœ… å¿…é ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹: å®Ÿè£…ç¢ºèªæ¸ˆã¿
- âœ… ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: å®Ÿè¡Œå®Œäº†

### è¿½åŠ ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«

${agentFiles}

### æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

æ–°ã—ã„ Agent ã¯ \`CoordinatorAgent\` ã®ã‚¿ã‚¹ã‚¯å‰²ã‚Šå½“ã¦å¯¾è±¡ã«å«ã¾ã‚Œã¾ã™ã€‚

---

**AGENTS.md å‚ç…§:** [è‡ªå‹•ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ãƒ—ãƒ­ãƒˆã‚³ãƒ«](../AGENTS.md#autonomous_onboarding_protocol_for_new_agents)
              `,
              labels: ['agent-onboarding', 'automated']
            });

      - name: Failure notification
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;

            await github.rest.issues.create({
              owner,
              repo,
              title: 'âŒ Agent Onboarding Failed',
              body: `## ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—

æ–°ã—ã„ Agent ã®ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ—ãƒ­ã‚»ã‚¹ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚

### ç¢ºèªäº‹é …

1. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„ã‹
2. å¿…é ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ (\`execute()\` ã¾ãŸã¯ \`run()\`) ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹
3. ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹ã‹

### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è©³ç´°

[å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèª](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

---

**AGENTS.md å‚ç…§:** [è‡ªå‹•ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ãƒ—ãƒ­ãƒˆã‚³ãƒ«](../AGENTS.md#autonomous_onboarding_protocol_for_new_agents)
              `,
              labels: ['agent-onboarding', 'failed', 'needs-review']
            });
